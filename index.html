// 1. GESTION DU TIMER 24H PERSISTANT
function initTimer(durationInHours) {
    let startTime = localStorage.getItem('gemTimerStart');
    
    if (!startTime) {
        startTime = Date.now();
        localStorage.setItem('gemTimerStart', startTime);
    }

    const timerDisplay = document.getElementById('timer-display');

    setInterval(() => {
        const now = Date.now();
        const elapsed = now - startTime;
        const remaining = (durationInHours * 3600000) - elapsed;

        if (remaining <= 0) {
            timerDisplay.textContent = "00:00:00";
            return;
        }

        const h = Math.floor(remaining / 3600000);
        const m = Math.floor((remaining % 3600000) / 60000);
        const s = Math.floor((remaining % 60000) / 1000);

        timerDisplay.textContent = 
            `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }, 1000);
}

// 2. GESTION DU SCAN (Compatible Safari)
async function startScan() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('scan-video').srcObject = stream;
        
        // Simule une validation après 2 secondes
        setTimeout(() => {
            document.getElementById('exercise-section').classList.remove('locked');
            alert("Scan validé. Missions débloquées.");
        }, 2000);
    } catch (err) {
        alert("Erreur Scan : Veuillez autoriser la caméra dans Safari.");
    }
}

// 3. NAVIGATION DASHBOARD
const systemTab = document.getElementById('system-tab');
const dashboard = document.getElementById('dashboard-overlay');
const closeBtn = document.getElementById('close-dashboard');

systemTab.addEventListener('click', () => dashboard.classList.add('active'));
closeBtn.addEventListener('click', () => dashboard.classList.remove('active'));

// Lancer le timer au chargement
window.onload = () => initTimer(24);
